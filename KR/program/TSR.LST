Turbo Assembler	 Version 3.1	    05/06/24 21:06:55	    Page 1
tsr.asm



      1	0000			     CODEPR  SEGMENT PARA
      2				     ASSUME CS:CODEPR ,	DS:CODEPR
      3					ORG  100H	  ; Область PSP
      4				     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      5				     ; Резидентная часть
      6	0100  E9 00EA		     BEGIN:    JMP   INIT	       ; Переход к части инициализации
      7				     ;	      Данные резидента
      8	0103  ????????		     OLD_INT9H DD  ?		     ; Сохранение старого обработчика
      9	0107  01		     F1_FLAG DB	1
     10	0108  01		     F2_FLAG DB	1
     11	0109  01		     F3_FLAG DB	1
     12	010A  4C 61 72 6B 69 6E	20+  F9_MSG	 DB 'Larkin Б. В., ИУ5-41, Вар.	11', 10,13,'$'
     13	      81 2E 20 82 2E 2C	20+
     14	      88 93 35 2D 34 31	2C+
     15	      20 82 A0 E0 2E 20	31+
     16	      31 0A 0D 24
     17	012A  8B 8C 8D 8E 8F	     F2_RUS_ARR	DB "ЛМНОП"
     18	012F  4C 4D 4E 4F 50	     F2_latin_ARR DB "LMNOP"
     19
     20				     ;	 Новый обработчик прерывания 09Н
     21	0134			     NEWINT9:
     22	0134  50			PUSH   AX	      ;	Сохранение используемых	регистров
     23	0135  51			PUSH   CX
     24	0136  53			PUSH   BX
     25	0137  52			PUSH DX
     26				     ;	   Запрос сканкода из клавиатуры
     27	0138  E4 60			IN     AL, 60H	      ;	Взять из порта 60 Н на регистр AL
     28	013A  3C 01			CMP   AL, 1	      ;	Проверка сканкода ESC он равен 1
     29	013C  74 13			JE ESC_pressed
     30	013E  3C 43			CMP AL,	43h
     31	0140  74 27			JE F9_pressed
     32	0142  3C 3B			CMP AL,	3Bh
     33	0144  74 3C			JE F1_pressed
     34	0146  3C 3C			CMP AL,	3Ch
     35	0148  74 40			JE F2_pressed
     36	014A  3C 3D			CMP AL,	3Dh
     37	014C  74 44			JE F3_pressed
     38	014E  EB 53 90			JMP    PROCESS		 ;   Переход на	обработку символов
     39
     40	0151			     ESC_pressed:
     41				     ;	    Вывод на экран 10-ти символов ?В? с	помощью	BIOS функции 0AH ? 010H
     42	0151  E4 61			IN  AL,	61H
     43	0153  0C 80			OR AL, 10000000b     ; установим бит 7 порта В
     44	0155  E6 61			OUT 61H, AL
     45	0157  24 7F			AND AL,	01111111b
     46	0159  E6 61			OUT  61H, AL	     ;	сбросим	бит 7 порта  В (символ прочитан)
     47				      ;	  Вывод	цепочки	10 символов
     48	015B  B4 0A			MOV AH , 0AH
     49	015D  B0 42			MOV AL,	'B'
     50	015F  B7 00			MOV BH , 0
     51	0161  B9 000A			MOV CX,	10	       ;Число символов
     52	0164  CD 10			INT 10H		      ;	INT BIOS DOS
     53	0166  EB 32 90			JMP Override_return
     54
     55	0169			     F9_pressed:
     56	0169  B0 01			MOV AL,	1
     57	016B  B7 00			MOV BH,	0
Turbo Assembler	 Version 3.1	    05/06/24 21:06:55	    Page 2
tsr.asm



     58	016D  B3 03			MOV BL,	3
     59	016F  B9 001E			MOV CX,	30 ;Длина строки
     60	0172  B6 0A			MOV DH,	10
     61	0174  B2 1E			MOV DL,	30
     62	0176  1E			PUSH DS	;Датасегмент в ES
     63	0177  07			POP ES
     64	0178  BD 010Ar			MOV BP,	OFFSET F9_MSG ;Оффсет датасегмента до начала строки
     65	017B  B4 13			MOV AH,	13h
     66	017D  CD 10			INT 10h
     67	017F  EB 19 90			JMP Override_return
     68
     69	0182			     F1_pressed:
     70	0182  80 36 0107r 01		XOR F1_FLAG, 1
     71	0187  EB 11 90			JMP Override_return
     72	018A			     F2_pressed:
     73	018A  80 36 0108r 01		XOR F2_FLAG, 1
     74	018F  EB 09 90			JMP Override_return
     75	0192			     F3_pressed:
     76	0192  80 36 0109r 01		XOR F3_FLAG, 1
     77	0197  EB 01 90			JMP Override_return
     78
     79	019A			     Override_return:
     80					;    Сигнал контроллеру	прерываний через порт 20Н сигнал (EOI =	20H)
     81	019A  5A			POP DX
     82	019B  5B			POP	BX
     83	019C  59			POP	CX
     84	019D  B0 20			MOV AL,20H
     85	019F  E6 20			OUT  20H , AL	      ;	 в порт	ведущего контроллера 8259A
     86	01A1  58			POP AX
     87	01A2  CF			IRET
     88	01A3			     PROCESS:
     89	01A3  FC			CLD
     90	01A4				CHECK_F3: ;Латиница
     91	01A4  80 3E 0109r 01		   CMP F3_FLAG,	1
     92	01A9  75 14			   JNE CHECK_F2
     93	01AB				   PROCESS_F3:
     94	01AB  3C 41			      cmp AL,'A'
     95	01AD  72 0D			      jb not_latin ;меньше A
     96	01AF  3C 5A			      cmp AL,'Z'
     97	01B1  76 08			      jna latin	;Не больше Z
     98	01B3  3C 61			      cmp AL,'a'
     99	01B5  72 05			      jb not_latin ;меньше a
    100	01B7  3C 7A			      cmp AL,'z'
    101	01B9  77 01			      ja not_latin ;больше z
    102	01BB				      latin:
    103	01BB  CF				 IRET ;Закончить обработку
    104	01BC				      not_latin:
    105	01BC  EB 1E 90				 JMP CHECK_F1 ;Не можем	попасть	в F2
    106	01BF				CHECK_F2: ;Попадание в массив
    107	01BF  BF 012Fr			   MOV DI, OFFSET F2_latin_ARR ;В AL лежит текущий символ
    108	01C2  8B F7			   MOV SI, DI
    109	01C4  B9 0005			   MOV CX, 5
    110	01C7  F2> AE			   REPNE SCASB
    111	01C9  74 03			   JZ found_f2
    112	01CB				   not_found_f2:
    113	01CB  EB 0F 90			      JMP CHECK_F1
    114	01CE				   found_f2:
Turbo Assembler	 Version 3.1	    05/06/24 21:06:55	    Page 3
tsr.asm



    115	01CE  8A 1E 012Ar		      MOV BL, F2_RUS_ARR
    116	01D2  80 C3 05			      ADD BL, 5	;Длина массива
    117	01D5  2A D9			      SUB BL, CL ;сколько пробежали
    118	01D7  B7 00			      MOV BH, 0
    119	01D9  8A 47 01			      MOV AL, byte [BX]	;соответствующий символ	из массива
    120
    121	01DC				CHECK_F1: ;Отрисовка буквы 'И'
    122	01DC  3C 88			   CMP AL, 'И'
    123	01DE  74 03			   JZ found_f1
    124	01E0  EB 02 90			   JMP final_processing
    125	01E3				   found_f1:
    126					      ;Отрисовка
    127	01E3  CF			      IRET
    128
    129	01E4				final_processing:
    130					   ;  Восстановление регистров и вызов старого обработчика без возврата
    131	01E4  5A			   POP DX
    132	01E5  5B			   POP	   BX
    133	01E6  59			   POP	   CX
    134	01E7  58			   POP	   AX
    135	01E8  2E: FF 2E	0103r		   JMP	CS:OLD_INT9H	  ; Вызов старого обработчика
    136
    137				     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    138				     ; Часть инициализации
    139	01ED  FA		     INIT:    CLI		 ; Запрет прерываний
    140				     ; Установка DS
    141	01EE  0E			      PUSH CS
    142	01EF  1F			      POP DS
    143				     ; Получение адреса	старого	обработчика
    144	01F0  B4 35			      MOV  AH, 35H
    145	01F2  B0 09			      MOV  AL, 09H    ;	Номер прерывания
    146	01F4  CD 21			      INT 21H
    147				     ;	Сохранение адреса старого обработчика
    148	01F6  89 1E 0103r		      MOV     WORD  PTR	 OLD_INT9H , BX
    149	01FA  8C 06 0105r		      MOV     WORD  PTR	 OLD_INT9H+2 , ES
    150				     ;	Установка нового обработчика в вектор прерывания
    151	01FE  B4 25			      MOV     AH,25H
    152	0200  B0 09			      MOV     AL, 09H	; Номер	прерывания
    153	0202  BA 0134r			      MOV     DX, OFFSET   NEWINT9
    154	0205  CD 21			      INT     21H
    155				     ; Вывод сообщения о загрузке резидента
    156	0207  B4 09			      MOV AH , 09H
    157	0209  BA 0217r			      MOV DX, OFFSET MSG
    158	020C  CD 21			      INT    21H
    159				     ; Завершить и оставить резидентной	(TSR)
    160	020E  B8 3100			      MOV     AX, 3100H
    161	0211  BA 001F			      MOV     DX, (init	- begin	+10FH)/16   ; Размер резидента
    162	0214  FB			      STI		  ; Разрешение прерываний
    163	0215  CD 21			      INT	21H
    164				     ;	Данные части инициализации
    165	0217  53 74 61 72 74 20	54+  MSG      DB 'Start	TSR', 10,13,'$'
    166	      53 52 0A 0D 24
    167	0223			     CODEPR   ENDS
    168				     END     BEGIN
Turbo Assembler	 Version 3.1	    05/06/24 21:06:55	    Page 4
Symbol Table




Symbol Name			  Type	 Value

??DATE				  Text	 "05/06/24"
??FILENAME			  Text	 "tsr	  "
??TIME				  Text	 "21:06:54"
??VERSION			  Number 030A
@CPU				  Text	 0101H
@CURSEG				  Text	 CODEPR
@FILENAME			  Text	 TSR
@WORDSIZE			  Text	 2
BEGIN				  Near	 CODEPR:0100
CHECK_F1			  Near	 CODEPR:01DC
CHECK_F2			  Near	 CODEPR:01BF
CHECK_F3			  Near	 CODEPR:01A4
ESC_PRESSED			  Near	 CODEPR:0151
F1_FLAG				  Byte	 CODEPR:0107
F1_PRESSED			  Near	 CODEPR:0182
F2_FLAG				  Byte	 CODEPR:0108
F2_LATIN_ARR			  Byte	 CODEPR:012F
F2_PRESSED			  Near	 CODEPR:018A
F2_RUS_ARR			  Byte	 CODEPR:012A
F3_FLAG				  Byte	 CODEPR:0109
F3_PRESSED			  Near	 CODEPR:0192
F9_MSG				  Byte	 CODEPR:010A
F9_PRESSED			  Near	 CODEPR:0169
FINAL_PROCESSING		  Near	 CODEPR:01E4
FOUND_F1			  Near	 CODEPR:01E3
FOUND_F2			  Near	 CODEPR:01CE
INIT				  Near	 CODEPR:01ED
LATIN				  Near	 CODEPR:01BB
MSG				  Byte	 CODEPR:0217
NEWINT9				  Near	 CODEPR:0134
NOT_FOUND_F2			  Near	 CODEPR:01CB
NOT_LATIN			  Near	 CODEPR:01BC
OLD_INT9H			  Dword	 CODEPR:0103
OVERRIDE_RETURN			  Near	 CODEPR:019A
PROCESS				  Near	 CODEPR:01A3
PROCESS_F3			  Near	 CODEPR:01AB

Groups & Segments		  Bit Size Align  Combine Class

CODEPR				  16  0223 Para	  none
