Turbo Assembler	 Version 3.1	    05/05/24 17:25:51	    Page 1
tsr.asm



      1	0000			     CODEPR  SEGMENT PARA
      2				     ASSUME CS:CODEPR ,	DS:CODEPR
      3					ORG  100H	  ; Область PSP
      4				     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      5				     ; Резидентная часть
      6	0100  EB 33 90		     BEGIN:    JMP   INIT	       ; Переход	к части инициализации
      7				     ;	      Данные резидента
      8	0103  ????????		     SAVEINT9 DD  ?		    ; Сохранение старого обработчика
      9				     ;	 Новый обработчик прерывания 09Н
     10	0107			     NEWINT9:
     11	0107  50			PUSH   AX	      ;	Сохранение используемых регистров
     12	0108  51			PUSH   CX
     13	0109  53			PUSH   BX
     14				     ;	   Запрос	сканкода из клавиатуры
     15	010A  E4 60			IN     AL, 60H	      ;	Взять из	порта 60 Н на регистр AL
     16	010C  3C 01			CMP   AL, 1	      ;	Проверка сканкода ESC он равен 1
     17	010E  75 1D			JNE    EXIT	      ;	  Переход если не ESC
     18				     ;	    Вывод на экран 10-ти символов	’В’ с помощью BIOS	    +
     19				     функции 0AH	– 010H
     20	0110  E4 61			IN  AL,	61H
     21	0112  0C 80			OR AL, 10000000b     ; установим бит 7 порта В
     22	0114  E6 61			OUT 61H, AL
     23	0116  24 7F			AND AL,	01111111b
     24	0118  E6 61			OUT  61H, AL	     ;	сбросим бит 7	порта  В (символ		    +
     25				     прочитан)
     26				      ;	  Вывод цепочки 10 символов
     27	011A  B4 0A			MOV AH , 0AH
     28	011C  B0 42			MOV AL,	'B'
     29	011E  B7 00			MOV BH , 0
     30	0120  B9 000A			MOV CX,	10	       ;Число символов
     31	0123  CD 10			INT 010H	       ; INT BIOS DOS
     32	0125  59			POP CX		       ;  восстановление регистров
     33	0126  5B			POP BX
     34				     ;	  Сигнал контроллеру прерываний через порт 20Н	    +
     35				     сигнал (EOI = 20H)
     36	0127  B0 20			MOV AL,20H
     37	0129  E6 20			OUT  20H , AL	      ;	 в порт ведущего контроллера 8259A
     38	012B  58			POP AX
     39	012C  CF			IRET
     40				     ;	Восстановление регистров	и вызов старого		    +
     41				     обработчика без возврата
     42	012D			     EXIT:
     43	012D  5B			POP	BX
     44	012E  59			POP	CX
     45	012F  58			POP	AX
     46	0130  2E: FF 2E	0103r		JMP  CS:SAVEINT9      ;	Вызов старого обработчика
     47				     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     48				     ; Часть инициализации
     49	0135  FA		     INIT:    CLI		 ; Запрет	прерываний
     50				     ; Установка DS
     51	0136  0E			      PUSH CS
     52	0137  1F			      POP DS
     53				     ; Получение адреса старого обработчика
     54	0138  B4 35			      MOV  AH, 35H
     55	013A  B0 09			      MOV  AL, 09H    ;	Номер прерывания
     56	013C  CD 21			      INT 21H
     57				     ;	Сохранение адреса старого обработчика
Turbo Assembler	 Version 3.1	    05/05/24 17:25:51	    Page 2
tsr.asm



     58	013E  89 1E 0103r		      MOV     WORD  PTR	 SAVEINT9 , BX
     59	0142  8C 06 0105r		      MOV     WORD  PTR	 SAVEINT9+2 , ES
     60				     ;	Установка нового	обработчика в вектор прерывания
     61	0146  B4 25			      MOV     AH,25H
     62	0148  B0 09			      MOV     AL, 09H	; Номер прерывания
     63	014A  BA 0107r			      MOV     DX, OFFSET   NEWINT9
     64	014D  CD 21			      INT     21H
     65				     ; Вывод сообщения о	загрузке резидента
     66	014F  B4 09			      MOV AH , 09H
     67	0151  BA 015Fr			      MOV DX, OFFSET MSG
     68	0154  CD 21			      INT    21H
     69				     ; Завершить и оставить резидентной (TSR)
     70	0156  B8 3100			      MOV     AX, 3100H
     71	0159  BA 0014			      MOV     DX, (init	- begin	+10FH)/16   ; Размер резидента
     72	015C  FB			      STI		  ; Разрешение прерываний
     73	015D  CD 21			      INT	21H
     74				     ;	Данные части	инициализации
     75	015F  53 74 61 72 74 20	54+  MSG      DB 'Start	TSR', 10,13,'$'
     76	      53 52 0A 0D 24
     77	016B			     CODEPR   ENDS
     78				     END     BEGIN
Turbo Assembler	 Version 3.1	    05/05/24 17:25:51	    Page 3
Symbol Table




Symbol Name			  Type	 Value

??DATE				  Text	 "05/05/24"
??FILENAME			  Text	 "tsr	  "
??TIME				  Text	 "17:25:51"
??VERSION			  Number 030A
@CPU				  Text	 0101H
@CURSEG				  Text	 CODEPR
@FILENAME			  Text	 TSR
@WORDSIZE			  Text	 2
BEGIN				  Near	 CODEPR:0100
EXIT				  Near	 CODEPR:012D
INIT				  Near	 CODEPR:0135
MSG				  Byte	 CODEPR:015F
NEWINT9				  Near	 CODEPR:0107
SAVEINT9			  Dword	 CODEPR:0103

Groups & Segments		  Bit Size Align  Combine Class

CODEPR				  16  016B Para	  none
