Turbo Assembler	 Version 3.1	    05/06/24 17:57:57	    Page 1
tsr.asm



      1	0000			     CODEPR  SEGMENT PARA
      2				     ASSUME CS:CODEPR ,	DS:CODEPR
      3					ORG  100H	  ; Область PSP
      4				     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      5				     ; Резидентная часть
      6	0100  E9 00F6		     BEGIN:    JMP   INIT	       ; Переход	к части инициализации
      7				     ;	      Данные резидента
      8	0103  ????????		     OLD_INT9H DD  ?		     ; Сохранение старого обработчика
      9	0107  01		     F1_FLAG DB	1
     10	0108  01		     F2_FLAG DB	1
     11	0109  01		     F3_FLAG DB	1
     12	010A  D0 9B D0 B0 D1 80	D0+  F9_MSG	 DB 'Ларкин Б. В., ИУ5-41, Вар. 11', 10,13,'$'
     13	      BA D0 B8 D0 BD 20	D0+
     14	      91 2E 20 D0 92 2E	2C+
     15	      20 D0 98 D0 A3 35	2D+
     16	      34 31 2C 20 D0 92	D0+
     17	      B0 D1 80 2E 20 31	31+
     18	      0A 0D 24
     19
     20
     21				     ;	 Новый обработчик прерывания 09Н
     22	0137			     NEWINT9:
     23	0137  50			PUSH   AX	      ;	Сохранение используемых регистров
     24	0138  51			PUSH   CX
     25	0139  53			PUSH   BX
     26	013A  52			PUSH DX
     27				     ;	   Запрос	сканкода из клавиатуры
     28	013B  E4 60			IN     AL, 60H	      ;	Взять из	порта 60 Н на регистр AL
     29	013D  3C 01			CMP   AL, 1	      ;	Проверка сканкода ESC он равен 1
     30	013F  74 13			JE ESC_pressed
     31	0141  3C 43			CMP AL,	43h
     32	0143  74 32			JE F9_pressed
     33	0145  3C 3B			CMP AL,	3Bh
     34	0147  74 47			JE F1_pressed
     35	0149  3C 3C			CMP AL,	3Ch
     36	014B  74 60			JE F2_pressed
     37	014D  3C 3D			CMP AL,	3Dh
     38	014F  74 79			JE F3_pressed
     39	0151  E9 009C			JMP    EXIT	      ;	  Переход если не ESC
     40
     41	0154			     ESC_pressed:
     42				     ;	    Вывод на экран 10-ти символов	’В’ с помощью BIOS	    +
     43				     функции 0AH	– 010H
     44	0154  E4 61			IN  AL,	61H
     45	0156  0C 80			OR AL, 10000000b     ; установим бит 7 порта В
     46	0158  E6 61			OUT 61H, AL
     47	015A  24 7F			AND AL,	01111111b
     48	015C  E6 61			OUT  61H, AL	     ;	сбросим бит 7	порта  В (символ		    +
     49				     прочитан)
     50				      ;	  Вывод цепочки 10 символов
     51	015E  B4 0A			MOV AH , 0AH
     52	0160  B0 42			MOV AL,	'B'
     53	0162  B7 00			MOV BH , 0
     54	0164  B9 000A			MOV CX,	10	       ;Число символов
     55	0167  CD 10			INT 10H		      ;	INT BIOS DOS
     56	0169  B4 03			MOV AH,	03h
     57	016B  CD 10			INT 10H
Turbo Assembler	 Version 3.1	    05/06/24 17:57:57	    Page 2
tsr.asm



     58	016D  B4 02			MOV AH,	02h
     59	016F  80 C6 0A			ADD DH,	10
     60	0172  CD 10			INT 10h
     61	0174  EB 71 90			JMP Override_return
     62
     63	0177			     F9_pressed:
     64	0177  B0 01			MOV AL,	1
     65	0179  B7 00			MOV BH,	0
     66	017B  B3 03			MOV BL,	3
     67	017D  B9 001E			MOV CX,	30 ;Длина строки
     68	0180  B6 0A			MOV DH,	10
     69	0182  B2 1E			MOV DL,	30
     70	0184  1E			PUSH DS	;Датасегмент	в ES
     71	0185  07			POP ES
     72	0186  BD 010Ar			MOV BP,	OFFSET F9_MSG ;Оффсет датасегмента до начала строки
     73	0189  B4 13			MOV AH,	13h
     74	018B  CD 10			INT 10h
     75	018D  EB 58 90			JMP Override_return
     76
     77	0190			     F1_pressed:
     78	0190  80 36 0107r 01		XOR F1_FLAG, 1
     79	0195  E4 61			IN  AL,	61H
     80	0197  0C 80			OR AL, 10000000b     ; установим бит 7 порта В
     81	0199  E6 61			OUT 61H, AL
     82	019B  24 7F			AND AL,	01111111b
     83	019D  E6 61			OUT  61H, AL	     ;	сбросим бит 7	порта  В (символ		    +
     84				     прочитан)
     85				      ;	  Вывод цепочки 10 символов
     86	019F  B4 0A			MOV AH , 0AH
     87	01A1  B0 31			MOV AL,	'1'
     88	01A3  B7 00			MOV BH , 0
     89	01A5  B9 000A			MOV CX,	10	       ;Число символов
     90	01A8  CD 10			INT 010H	       ; INT BIOS DOS
     91	01AA  EB 3B 90			JMP Override_return
     92	01AD			     F2_pressed:
     93	01AD  80 36 0108r 01		XOR F2_FLAG, 1
     94	01B2  E4 61			IN  AL,	61H
     95	01B4  0C 80			OR AL, 10000000b     ; установим бит 7 порта В
     96	01B6  E6 61			OUT 61H, AL
     97	01B8  24 7F			AND AL,	01111111b
     98	01BA  E6 61			OUT  61H, AL	     ;	сбросим бит 7	порта  В (символ		    +
     99				     прочитан)
    100				      ;	  Вывод цепочки 10 символов
    101	01BC  B4 0A			MOV AH , 0AH
    102	01BE  B0 32			MOV AL,	'2'
    103	01C0  B7 00			MOV BH , 0
    104	01C2  B9 000A			MOV CX,	10	       ;Число символов
    105	01C5  CD 10			INT 010H	       ; INT BIOS DOS
    106	01C7  EB 1E 90			JMP Override_return
    107	01CA			     F3_pressed:
    108	01CA  80 36 0109r 01		XOR F3_FLAG, 1
    109	01CF  E4 61			IN  AL,	61H
    110	01D1  0C 80			OR AL, 10000000b     ; установим бит 7 порта В
    111	01D3  E6 61			OUT 61H, AL
    112	01D5  24 7F			AND AL,	01111111b
    113	01D7  E6 61			OUT  61H, AL	     ;	сбросим бит 7	порта  В (символ		    +
    114				     прочитан)
Turbo Assembler	 Version 3.1	    05/06/24 17:57:57	    Page 3
tsr.asm



    115				      ;	  Вывод цепочки 10 символов
    116	01D9  B4 0A			MOV AH , 0AH
    117	01DB  B0 33			MOV AL,	'3'
    118	01DD  B7 00			MOV BH , 0
    119	01DF  B9 000A			MOV CX,	10	       ;Число символов
    120	01E2  CD 10			INT 010H	       ; INT BIOS DOS
    121	01E4  EB 01 90			JMP Override_return
    122
    123	01E7			     Override_return:
    124					;    Сигнал контроллеру прерываний через порт 20Н	    +
    125				     сигнал (EOI = 20H)
    126	01E7  5A			POP DX
    127	01E8  5B			POP	BX
    128	01E9  59			POP	CX
    129	01EA  B0 20			MOV AL,20H
    130	01EC  E6 20			OUT  20H , AL	      ;	 в порт ведущего контроллера 8259A
    131	01EE  58			POP AX
    132	01EF  CF			IRET
    133
    134	01F0			     EXIT:
    135				     ;	Восстановление регистров	и вызов старого		    +
    136				     обработчика без возврата
    137	01F0  5A			POP DX
    138	01F1  5B			POP	BX
    139	01F2  59			POP	CX
    140	01F3  58			POP	AX
    141	01F4  2E: FF 2E	0103r		JMP  CS:OLD_INT9H      ; Вызов старого обработчика
    142				     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    143				     ; Часть инициализации
    144	01F9  FA		     INIT:    CLI		 ; Запрет	прерываний
    145				     ; Установка DS
    146	01FA  0E			      PUSH CS
    147	01FB  1F			      POP DS
    148				     ; Получение адреса старого обработчика
    149	01FC  B4 35			      MOV  AH, 35H
    150	01FE  B0 09			      MOV  AL, 09H    ;	Номер прерывания
    151	0200  CD 21			      INT 21H
    152				     ;	Сохранение адреса старого обработчика
    153	0202  89 1E 0103r		      MOV     WORD  PTR	 OLD_INT9H , BX
    154	0206  8C 06 0105r		      MOV     WORD  PTR	 OLD_INT9H+2 , ES
    155				     ;	Установка нового	обработчика в вектор прерывания
    156	020A  B4 25			      MOV     AH,25H
    157	020C  B0 09			      MOV     AL, 09H	; Номер прерывания
    158	020E  BA 0137r			      MOV     DX, OFFSET   NEWINT9
    159	0211  CD 21			      INT     21H
    160				     ; Вывод сообщения о	загрузке резидента
    161	0213  B4 09			      MOV AH , 09H
    162	0215  BA 0223r			      MOV DX, OFFSET MSG
    163	0218  CD 21			      INT    21H
    164				     ; Завершить и оставить резидентной (TSR)
    165	021A  B8 3100			      MOV     AX, 3100H
    166	021D  BA 0020			      MOV     DX, (init	- begin	+10FH)/16   ; Размер резидента
    167	0220  FB			      STI		  ; Разрешение прерываний
    168	0221  CD 21			      INT	21H
    169				     ;	Данные части	инициализации
    170	0223  53 74 61 72 74 20	54+  MSG      DB 'Start	TSR', 10,13,'$'
    171	      53 52 0A 0D 24
Turbo Assembler	 Version 3.1	    05/06/24 17:57:57	    Page 4
tsr.asm



    172	022F			     CODEPR   ENDS
    173				     END     BEGIN
Turbo Assembler	 Version 3.1	    05/06/24 17:57:57	    Page 5
Symbol Table




Symbol Name			  Type	 Value

??DATE				  Text	 "05/06/24"
??FILENAME			  Text	 "tsr	  "
??TIME				  Text	 "17:57:57"
??VERSION			  Number 030A
@CPU				  Text	 0101H
@CURSEG				  Text	 CODEPR
@FILENAME			  Text	 TSR
@WORDSIZE			  Text	 2
BEGIN				  Near	 CODEPR:0100
ESC_PRESSED			  Near	 CODEPR:0154
EXIT				  Near	 CODEPR:01F0
F1_FLAG				  Byte	 CODEPR:0107
F1_PRESSED			  Near	 CODEPR:0190
F2_FLAG				  Byte	 CODEPR:0108
F2_PRESSED			  Near	 CODEPR:01AD
F3_FLAG				  Byte	 CODEPR:0109
F3_PRESSED			  Near	 CODEPR:01CA
F9_MSG				  Byte	 CODEPR:010A
F9_PRESSED			  Near	 CODEPR:0177
INIT				  Near	 CODEPR:01F9
MSG				  Byte	 CODEPR:0223
NEWINT9				  Near	 CODEPR:0137
OLD_INT9H			  Dword	 CODEPR:0103
OVERRIDE_RETURN			  Near	 CODEPR:01E7

Groups & Segments		  Bit Size Align  Combine Class

CODEPR				  16  022F Para	  none
